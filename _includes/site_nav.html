{%- comment -%}
  Global site navigation
  - Appears at the top of every page (default layout)
  - Highlights active section
{%- endcomment -%}

{%- assign url = page.url | default: '/' -%}
{%- assign is_home = page.id == 'home' or url == '/' -%}
{%- assign in_rockhounding = url contains '/rockhounding/' -%}
{%- assign in_games = url contains '/games/' -%}
{%- assign in_logs = url contains '/logs/' -%}
{%- assign on_about = url == '/about' or url contains '/about/' -%}

<nav class="site-nav" role="navigation" aria-label="Primary">
  <a class="internal-link nav-home{% if is_home %} nav-link--active{% endif %}"
     href="/"{% if is_home %} aria-current="page"{% endif %}><strong>{{ site.title }}</strong></a>
  <button class="menu-toggle" aria-expanded="false" aria-controls="site-menu" aria-label="Toggle navigation">Menu</button>
  <button class="theme-toggle" id="theme-toggle" aria-pressed="false" aria-label="Toggle dark mode">ðŸŒ™</button>

  <ul class="nav-links" id="site-menu">
    <li class="has-dropdown">
      <a class="internal-link{% if in_rockhounding %} nav-link--active{% endif %}"
         href="/rockhounding/"{% if in_rockhounding %} aria-current="page"{% endif %}
         aria-haspopup="true" aria-controls="nav-dropdown-rockhounding"{% if in_rockhounding %} aria-expanded="true"{% else %} aria-expanded="false"{% endif %}>Rockhounding</a>
      <ul class="dropdown" id="nav-dropdown-rockhounding">
        <li>
          <a class="internal-link{% if url == '/rockhounding/' %} nav-link--active{% endif %}"
             href="/rockhounding/"{% if url == '/rockhounding/' %} aria-current="page"{% endif %}>Overview</a>
        </li>
        <li>
          <a class="internal-link{% if url contains '/rockhounding/rocks/' %} nav-link--active{% endif %}"
             href="/rockhounding/rocks/"{% if url contains '/rockhounding/rocks/' %} aria-current="page"{% endif %}>Rocks &amp; Minerals</a>
        </li>
        <li>
          <a class="internal-link{% if url contains '/rockhounding/guides/' %} nav-link--active{% endif %}"
             href="/rockhounding/guides/"{% if url contains '/rockhounding/guides/' %} aria-current="page"{% endif %}>Guides</a>
        </li>
        
        <li>
          <a class="internal-link{% if url contains '/rockhounding/logs/' %} nav-link--active{% endif %}"
             href="/rockhounding/logs/"{% if url contains '/rockhounding/logs/' %} aria-current="page"{% endif %}>Logbook</a>
        </li>
        <li>
          <a class="internal-link{% if url contains '/rockhounding/resources/' %} nav-link--active{% endif %}"
             href="/rockhounding/resources/"{% if url contains '/rockhounding/resources/' %} aria-current="page"{% endif %}>Resources</a>
        </li>
      </ul>
    </li>

    <li>
      <a class="internal-link{% if in_games %} nav-link--active{% endif %}"
         href="/games/"{% if in_games %} aria-current="page"{% endif %}>Games</a>
    </li>
    <li>
      <a class="internal-link{% if on_about %} nav-link--active{% endif %}"
         href="/about"{% if on_about %} aria-current="page"{% endif %}>About</a>
    </li>
  </ul>
</nav>

<script>
  (function() {
    var nav = document.querySelector('.site-nav');
    if (!nav) return;
    var btn = nav.querySelector('.menu-toggle');
    var menu = nav.querySelector('#site-menu');
    if (!btn || !menu) return;

    btn.addEventListener('click', function() {
      var isOpen = nav.classList.toggle('is-open');
      btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        nav.classList.remove('is-open');
        btn.setAttribute('aria-expanded', 'false');
      }
    });

    document.addEventListener('click', function(e) {
      if (!nav.contains(e.target)) {
        nav.classList.remove('is-open');
        btn.setAttribute('aria-expanded', 'false');
      }
    });
  })();

  // Theme toggle (light/dark)
  (function() {
    var btn = document.getElementById('theme-toggle');
    if (!btn) return;

    var root = document.documentElement;
    var storageKey = 'theme';

    function currentTheme() {
      return root.getAttribute('data-theme') || 'light';
    }

    function applyTheme(mode) {
      root.setAttribute('data-theme', mode);
      try { localStorage.setItem(storageKey, mode); } catch (e) {}
      btn.setAttribute('aria-pressed', mode === 'dark' ? 'true' : 'false');
      btn.textContent = mode === 'dark' ? 'â˜€ï¸Ž' : 'ðŸŒ™';
      btn.title = mode === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';
    }

    // Initial: prefer saved, else OS preference
    var saved = null;
    try { saved = localStorage.getItem(storageKey); } catch (e) {}
    if (saved === 'dark' || saved === 'light') {
      applyTheme(saved);
    } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      applyTheme('dark');
    } else {
      applyTheme('light');
    }

    btn.addEventListener('click', function() {
      applyTheme(currentTheme() === 'dark' ? 'light' : 'dark');
    });
  })();
</script>
