<div class="rock-card">
  {% assign thumb = include.rock.thumbnail | default: include.rock.cover %}
  {%- comment -%} Disallow tumbling images for rocks/minerals and verify file exists {%- endcomment -%}
  {% assign show_thumb = false %}
  {% assign final_thumb = nil %}
  {% if thumb %}
    {% if thumb contains '://' %}
      {% assign final_thumb = thumb %}
      {% assign show_thumb = true %}
    {% else %}
      {% assign exists = thumb | image_exists %}
      {% if exists and exists contains '/assets/tumbling/' %}
        {% assign show_thumb = false %}
      {% elsif exists %}
        {% assign final_thumb = exists %}
        {% assign show_thumb = true %}
      {% endif %}
    {% endif %}
  {% endif %}

  {% if show_thumb and final_thumb %}
    {% assign is_detail = false %}
    {% if page.path and include.rock.path and page.path == include.rock.path %}
      {% assign is_detail = true %}
    {% endif %}
    {% assign cache_bust = site.time | date: '%s' %}
    {% if is_detail %}
      <div class="rock-hero">
        {% if final_thumb contains '://' %}
          {% assign sep = '?' %}
          {% if final_thumb contains '?' %}{% assign sep = '&' %}{% endif %}
          {% assign img_src_ext = final_thumb | append: sep | append: 'v=' | append: cache_bust %}
          <img src="{{ img_src_ext | uri_escape }}" alt="{{ include.rock.title }}">
        {% else %}
        {% assign final_thumb_url = final_thumb | relative_url %}
        {% assign final_thumb_url = final_thumb_url | append: '?v=' | append: cache_bust %}
        <img src="{{ final_thumb_url | uri_escape }}" alt="{{ include.rock.title }}">
        {% endif %}
      </div>
    {% else %}
      <a class="rock-thumb" href="{{ include.rock.url | relative_url }}">
        {% if final_thumb contains '://' %}
          {% assign sep = '?' %}
          {% if final_thumb contains '?' %}{% assign sep = '&' %}{% endif %}
          {% assign img_src_ext = final_thumb | append: sep | append: 'v=' | append: cache_bust %}
          <img src="{{ img_src_ext | uri_escape }}" alt="{{ include.rock.title }}">
        {% else %}
          {% assign final_thumb_url = final_thumb | relative_url %}
          {% assign final_thumb_url = final_thumb_url | append: '?v=' | append: cache_bust %}
          <img src="{{ final_thumb_url | uri_escape }}" alt="{{ include.rock.title }}">
        {% endif %}
      </a>
    {% endif %}
    {%- comment -%}
      Image credit appears only on detail pages (when include.rock == current page)
    {%- endcomment -%}
    {% if is_detail %}
      {% assign credit_label = nil %}
      {% assign credit_href  = nil %}
      {%- comment -%}
        Allow explicit credit override via front matter on the note:
        image_credit (label) and image_credit_url (link). If not provided,
        fall back to heuristics based on the image URL.
      {%- endcomment -%}
      {% if include.rock.image_credit or include.rock.image_credit_url %}
        {% assign credit_href  = include.rock.image_credit_url %}
        {% assign credit_label = include.rock.image_credit | default: 'Image Source' %}
      {% elsif final_thumb contains 'upload.wikimedia.org' %}
        {% assign parts = final_thumb | split: '/' %}
        {% assign file_name = parts | last | url_decode %}
        {% assign credit_href = 'https://commons.wikimedia.org/wiki/File:' | append: file_name %}
        {% assign credit_label = 'Wikimedia Commons' %}
      {% elsif final_thumb contains '://' %}
        {% assign credit_href = final_thumb %}
        {% assign credit_label = 'Image Source' %}
      {% else %}
        {% assign credit_label = 'Photo: Spectrum Syntax' %}
      {% endif %}
      {% if credit_label %}
        <div class="img-credit">
          {% if credit_href %}
            <a href="{{ credit_href | uri_escape }}" target="_blank" rel="noopener noreferrer">{{ credit_label }}</a>
          {% else %}
            {{ credit_label }}
          {% endif %}
        </div>
      {% endif %}
    {% endif %}
  {% else %}
    <a class="rock-thumb rock-thumb--empty" href="{{ include.rock.url | relative_url }}" aria-label="Open {{ include.rock.title }}">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <rect x="2" y="4" width="20" height="16" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="1.5"/>
        <circle cx="8" cy="10" r="2" fill="currentColor"/>
        <path d="M5 18l5-6 4 5 3-3 3 4" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </a>
  {% endif %}
  <h3><a href="{{ include.rock.url | relative_url }}">{{ include.rock.title }}</a></h3>
  {%- comment -%} Parent category chip {%- endcomment -%}
  {%- assign parent_url = nil -%}
  {%- assign parent_label = nil -%}
  {%- assign p = include.rock.path | default: '' -%}
  {%- assign u = include.rock.url  | default: '' -%}
  {%- if p contains '_notes/rockhounding/rocks/igneous/' -%}
    {%- assign parent_url = '/rockhounding/rocks/igneous/' -%}
    {%- assign parent_label = 'Igneous' -%}
  {%- elsif p contains '_notes/rockhounding/rocks/metamorphic/' -%}
    {%- assign parent_url = '/rockhounding/rocks/metamorphic/' -%}
    {%- assign parent_label = 'Metamorphic' -%}
  {%- elsif p contains '_notes/rockhounding/rocks/sedimentary/' -%}
    {%- assign parent_url = '/rockhounding/rocks/sedimentary/' -%}
    {%- assign parent_label = 'Sedimentary' -%}
  {%- elsif p contains '_notes/rockhounding/rocks/minerals/' and u contains '/rockhounding/rocks/minerals/' -%}
    {%- assign segs = u | split: '/' -%}
    {%- assign last_nonempty = '' -%}
    {%- assign second_last_nonempty = '' -%}
    {%- for s in segs -%}
      {%- if s != '' -%}
        {%- assign second_last_nonempty = last_nonempty -%}
        {%- assign last_nonempty = s -%}
      {%- endif -%}
    {%- endfor -%}
    {%- assign parent_label = second_last_nonempty | replace: '-', ' ' | title_case -%}
    {%- comment -%} Rebuild parent URL up to and including second_last_nonempty {%- endcomment -%}
    {%- assign parent_url = '' -%}
    {%- for s in segs -%}
      {%- if s != '' -%}
        {%- if s == second_last_nonempty -%}
          {%- assign parent_url = parent_url | append: '/' | append: s | append: '/' -%}
          {%- break -%}
        {%- else -%}
          {%- assign parent_url = parent_url | append: '/' | append: s -%}
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
  {%- if parent_url and parent_label -%}
    <div class="chips rock-parent-chips">
      <a class="chip" href="{{ parent_url | relative_url }}">{{ parent_label }}</a>
    </div>
  {%- endif -%}
  {%- comment -%} Show hardness first {%- endcomment -%}
  {% if include.rock.hardness %}
    {% assign hardness_val = include.rock.hardness | append: '' %}
    {% assign approx_flag = hardness_val | slice: 0, 1 %}
    <p class="rock-card-meta">
      Hardness: {{ hardness_val }}
      {% if approx_flag == 'â‰ˆ' %}
        <span class="approx-flag" title="Approximate">Approximate</span>
      {% endif %}
    </p>
  {% endif %}
  {%- comment -%} For minerals, show streak under hardness if available {%- endcomment -%}
  {%- if p contains '_notes/rockhounding/rocks/minerals/' and include.rock.streak -%}
    <p class="rock-card-meta">Streak: {{ include.rock.streak }}</p>
  {%- endif -%}
  {%- comment -%}
    Prefer explicit description. Otherwise, use the note excerpt stripped of
    HTML. Credits are rendered only on detail pages, not part of note content,
    so excerpts are safe for listings.
  {%- endcomment -%}
  {% assign display_desc = include.rock.description | default: include.rock.excerpt %}
  {% assign display_desc = display_desc | strip_html %}
  {% if display_desc %}
    <p>{{ display_desc | truncate: 160 }}</p>
  {% endif %}
  {%- if is_detail -%}
    {%- include related-chips.html doc=include.rock -%}
  {%- endif -%}
</div>
