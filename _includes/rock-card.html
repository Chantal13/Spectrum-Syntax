<div class="rock-card">
  {% assign thumb = include.rock.thumbnail | default: include.rock.cover %}
  {%- comment -%} Disallow tumbling images for rocks/minerals and verify file exists {%- endcomment -%}
  {% assign show_thumb = false %}
  {% assign final_thumb = nil %}
  {% if thumb %}
    {% if thumb contains '://' %}
      {% assign final_thumb = thumb %}
      {% assign show_thumb = true %}
    {% else %}
      {% assign exists = thumb | image_exists %}
      {% if exists and exists contains '/assets/tumbling/' %}
        {% assign show_thumb = false %}
      {% elsif exists %}
        {% assign final_thumb = exists %}
        {% assign show_thumb = true %}
      {% endif %}
    {% endif %}
  {% endif %}

  {% if show_thumb and final_thumb %}
    <a class="rock-thumb" href="{{ include.rock.url | relative_url }}">
      {% if final_thumb contains '://' %}
        <img src="{{ final_thumb | uri_escape }}" alt="{{ include.rock.title }}">
      {% else %}
        {% assign thumb_webp = final_thumb | replace: '.jpeg', '.webp' | replace: '.jpg', '.webp' | replace: '.png', '.webp' %}
        <picture>
          <source type="image/webp" srcset="{{ thumb_webp | relative_url | uri_escape }}">
          <img src="{{ final_thumb | relative_url | uri_escape }}" alt="{{ include.rock.title }}">
        </picture>
      {% endif %}
    </a>
    {%- comment -%}
      Image credit appears only on detail pages (when include.rock == current page)
    {%- endcomment -%}
    {% if include.rock.url == page.url %}
      {% assign credit_label = nil %}
      {% assign credit_href  = nil %}
      {% if final_thumb contains 'upload.wikimedia.org' %}
        {% assign parts = final_thumb | split: '/' %}
        {% assign file_name = parts | last | url_decode %}
        {% assign credit_href = 'https://commons.wikimedia.org/wiki/File:' | append: file_name %}
        {% assign credit_label = 'Wikimedia Commons' %}
      {% elsif final_thumb contains '://' %}
        {% assign credit_href = final_thumb %}
        {% assign credit_label = 'Image Source' %}
      {% else %}
        {% assign credit_label = 'Photo: Spectrum Syntax' %}
      {% endif %}
      {% if credit_label %}
        <div class="img-credit">
          {% if credit_href %}
            <a href="{{ credit_href | uri_escape }}" target="_blank" rel="noopener noreferrer">{{ credit_label }}</a>
          {% else %}
            {{ credit_label }}
          {% endif %}
        </div>
      {% endif %}
    {% endif %}
  {% else %}
    <a class="rock-thumb rock-thumb--empty" href="{{ include.rock.url | relative_url }}" aria-label="Open {{ include.rock.title }}">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <rect x="2" y="4" width="20" height="16" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="1.5"/>
        <circle cx="8" cy="10" r="2" fill="currentColor"/>
        <path d="M5 18l5-6 4 5 3-3 3 4" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </a>
  {% endif %}
  <h3><a href="{{ include.rock.url | relative_url }}">{{ include.rock.title }}</a></h3>
  {%- comment -%} Parent category chip {%- endcomment -%}
  {%- assign parent_url = nil -%}
  {%- assign parent_label = nil -%}
  {%- assign p = include.rock.path | default: '' -%}
  {%- assign u = include.rock.url  | default: '' -%}
  {%- if p contains '_notes/rockhounding/rocks/igneous/' -%}
    {%- assign parent_url = '/rockhounding/rocks/igneous/' -%}
    {%- assign parent_label = 'Igneous' -%}
  {%- elsif p contains '_notes/rockhounding/rocks/metamorphic/' -%}
    {%- assign parent_url = '/rockhounding/rocks/metamorphic/' -%}
    {%- assign parent_label = 'Metamorphic' -%}
  {%- elsif p contains '_notes/rockhounding/rocks/sedimentary/' -%}
    {%- assign parent_url = '/rockhounding/rocks/sedimentary/' -%}
    {%- assign parent_label = 'Sedimentary' -%}
  {%- elsif p contains '_notes/rockhounding/rocks/minerals/' and u contains '/rockhounding/rocks/minerals/' -%}
    {%- assign segs = u | split: '/' -%}
    {%- assign last_nonempty = '' -%}
    {%- assign second_last_nonempty = '' -%}
    {%- for s in segs -%}
      {%- if s != '' -%}
        {%- assign second_last_nonempty = last_nonempty -%}
        {%- assign last_nonempty = s -%}
      {%- endif -%}
    {%- endfor -%}
    {%- assign parent_label = second_last_nonempty | replace: '-', ' ' | title_case -%}
    {%- comment -%} Rebuild parent URL up to and including second_last_nonempty {%- endcomment -%}
    {%- assign parent_url = '' -%}
    {%- for s in segs -%}
      {%- if s != '' -%}
        {%- if s == second_last_nonempty -%}
          {%- assign parent_url = parent_url | append: '/' | append: s | append: '/' -%}
          {%- break -%}
        {%- else -%}
          {%- assign parent_url = parent_url | append: '/' | append: s -%}
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
  {%- if parent_url and parent_label -%}
    <div class="chips rock-parent-chips">
      <a class="chip" href="{{ parent_url | relative_url }}">{{ parent_label }}</a>
    </div>
  {%- endif -%}
  {% if include.rock.description %}
    <p>{{ include.rock.description }}</p>
  {% else %}
    <p>{{ include.rock.excerpt | strip_html | truncate: 160 }}</p>
  {% endif %}
  {% if include.rock.hardness %}
    <p class="rock-card-meta">Hardness: {{ include.rock.hardness }}</p>
  {% endif %}
  {%- if include.rock.url == page.url -%}
    {%- include related-chips.html doc=include.rock -%}
  {%- endif -%}
</div>
