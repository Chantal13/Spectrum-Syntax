{% if include.items %}
  {% assign items = include.items %}
{% else %}
  {% assign items = site.notes | where_exp: "n", "n.path contains '_notes/rockhounding/field-log/'" %}
  {% assign items = items | sort: "date" | reverse %}
{% endif %}

<div class="tumble-index">
  <table class="nice-table">
    <thead>
      <tr>
        <th>Entry</th>
        <th>Date</th>
        <th>Rocks</th>
        <th>Minerals</th>
      </tr>
    </thead>
    <tbody>
      {% if items and items.size > 0 %}
        {% for d in items %}
          {%- assign thumb = nil -%}
          {%- assign cand = d.thumbnail | image_exists -%}
          {% if cand %}{% assign thumb = cand %}{% endif %}
          {% if thumb == nil and d.images %}
            {%- assign cand = d.images.close_up | image_exists -%}
            {% if cand %}{% assign thumb = cand %}{% endif %}
          {% endif %}
          {% if thumb == nil and d.images %}
            {%- assign cand = d.images.scale | image_exists -%}
            {% if cand %}{% assign thumb = cand %}{% endif %}
          {% endif %}

          <tr>
            <td class="batch-cell">
              {% assign date_label = d.date | date: "%Y-%m-%d" %}
              {% assign title = d.title | default: '' | to_s | strip %}
              {% if title != '' %}
                {% assign display_text = date_label | append: " — " | append: title %}
              {% else %}
                {% assign display_text = date_label %}
              {% endif %}
              {% assign cache_bust = site.time | date: '%s' %}
              {% if thumb %}
                <a class="thumb" href="{{ d.url | relative_url }}" aria-label="Open {{ display_text }}">
                  <img src="{{ thumb | relative_url | append: '?v=' | append: cache_bust }}" alt="{{ display_text }}" onerror="this.parentNode.classList.add('thumb--empty'); this.remove();">
                  <span class="label">{{ display_text }}</span>
                </a>
              {% else %}
                <a class="thumb thumb--empty" href="{{ d.url | relative_url }}" aria-label="Open {{ display_text }}">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                    <rect x="2" y="4" width="20" height="16" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="1.5"/>
                    <circle cx="8" cy="10" r="2" fill="currentColor"/>
                    <path d="M5 18l5-6 4 5 3-3 3 4" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <span class="label">{{ display_text }}</span>
                </a>
              {% endif %}
              <div class="batch-meta">
                <a href="{{ d.url | relative_url }}">
                  <strong>{{ date_label }}</strong>{% if title != '' %} — {{ title }}{% endif %}
                </a>
                {% if d.rocks and d.rocks.size > 0 %}
                  <div class="chips">
                    {% for rock in d.rocks %}
                      {% assign rk = rock | downcase | strip | replace: " ", "-" | replace: "_", "-" | replace: "/", "-" %}
                      <span class="chip chip--{{ rk }}">{{ rock }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
                {% if d.minerals and d.minerals.size > 0 %}
                  <div class="chips">
                    {% for mineral in d.minerals %}
                      {% assign mk = mineral | downcase | strip | replace: " ", "-" | replace: "_", "-" | replace: "/", "-" %}
                      <span class="chip chip--{{ mk }}">{{ mineral }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </td>
            <td>{{ d.date | date: "%Y-%m-%d" }}</td>
            <td>
              {% if d.rocks and d.rocks.size > 0 %}
                <div class="chips">
                  {% for rock in d.rocks %}
                    {% assign rk = rock | downcase | strip | replace: " ", "-" | replace: "_", "-" | replace: "/", "-" %}
                    <span class="chip chip--{{ rk }}">{{ rock }}</span>
                  {% endfor %}
                </div>
              {% else %}—{% endif %}
            </td>
            <td>
              {% if d.minerals and d.minerals.size > 0 %}
                <div class="chips">
                  {% for mineral in d.minerals %}
                    {% assign mk = mineral | downcase | strip | replace: " ", "-" | replace: "_", "-" | replace: "/", "-" %}
                    <span class="chip chip--{{ mk }}">{{ mineral }}</span>
                  {% endfor %}
                </div>
              {% else %}—{% endif %}
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="4">No field log entries found. Put markdown files in <code>_notes/rockhounding/field-log/</code> with front matter.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

