---
layout: default
---

{% comment %}
Helpers
{% endcomment %}
{% assign brand = page.consumables_brand | default: "National Geographic" %}

{% assign cover_candidate =
  page.images.cover
  | default: page.images.after_stage_4
  | default: page.images.after_burnish
  | default: page.images.rough
%}
{% assign cover = cover_candidate | image_exists %}

<h1>{{ page.title }}</h1>

<div class="tumble-meta{% unless cover %} no-cover{% endunless %}">
  {% if cover %}
    <div class="tumble-cover">
      <img src="{{ cover | relative_url }}" alt="{{ page.title }} cover image">
    </div>
  {% endif %}

  <ul class="tumble-details">
    <li><strong>Batch:</strong> {{ page.batch }}</li>
    <li><strong>Status:</strong> {{ page.status | default: "Pending" }}</li>
    <li><strong>Started:</strong> {{ page.date_started | default: "—" }}</li>
    <li><strong>Finished:</strong> {{ page.date_finished | default: "—" }}</li>
    <li><strong>Tumbler:</strong> {{ page.tumbler | default: "—" }}</li>
    <li><strong>Origin:</strong> {{ page.origin | default: "—" }}</li>
    {% if page.rocks and page.rocks.size > 0 %}
    <li>
      <strong>Rocks:</strong>
      <span class="chips">
        {% for rock in page.rocks %}
          {% assign rk = rock | downcase | strip | replace: " ", "-" | replace: "_", "-" | replace: "/", "-" %}
          <span class="chip chip--{{ rk }}">{{ rock }}</span>
        {% endfor %}
      </span>
    </li>
    {% endif %}
  </ul>
</div>

{% if page.notes %}
<div class="tumble-notes">
  <h2>Notes</h2>
  <p>{{ page.notes }}</p>
</div>
{% endif %}

<hr>

<h2>Stages</h2>

{% assign empty_array = "" | split: "," %}
{% for st in page.stages %}
  {% assign imgs = st.images | default: empty_array %}
  {% assign primary = nil %}

  {% if imgs and imgs.size > 0 %}
    {% assign primary = imgs[0] %}
  {% endif %}

  {% if primary == nil %}
    {% assign k = "after_stage_" | append: st.stage %}
    {% assign primary = page.images[k] %}
  {% endif %}

  {%- comment -%} Fallbacks: prefer nearest previous stage image before using rough {%- endcomment -%}
  {% if primary == nil %}
    {% assign s = st.stage | plus: 0 %}
    {% if s == 5 %}
      {% assign primary = page.images.after_burnish %}
      {% if primary == nil %}
        {% assign primary = page.images.after_stage_4 %}
      {% endif %}
      {% if primary == nil %}
        {% assign primary = page.images.after_stage_3 %}
      {% endif %}
      {% if primary == nil %}
        {% assign primary = page.images.after_stage_2 %}
      {% endif %}
      {% if primary == nil %}
        {% assign primary = page.images.after_stage_1 %}
      {% endif %}
    {% elsif s == 4 %}
      {% assign primary = page.images.after_stage_3 %}
      {% if primary == nil %}
        {% assign primary = page.images.after_stage_2 %}
      {% endif %}
      {% if primary == nil %}
        {% assign primary = page.images.after_stage_1 %}
      {% endif %}
    {% elsif s == 3 %}
      {% assign primary = page.images.after_stage_2 %}
      {% if primary == nil %}
        {% assign primary = page.images.after_stage_1 %}
      {% endif %}
    {% elsif s == 2 %}
      {% assign primary = page.images.after_stage_1 %}
    {% endif %}
  {% endif %}

  {% if primary == nil %}
    {% assign primary = page.images.rough %}
  {% endif %}

  {% assign primary = primary | image_exists %}

  <section class="stage-card{% unless primary %} no-media{% endunless %}" id="stage-{{ st.stage }}">
    {% if primary %}
      <div class="stage-media">
        <img src="{{ primary | relative_url }}" alt="Stage {{ st.stage }} image">
      </div>
    {% endif %}
    <div class="stage-body">
      <h3>Stage {{ st.stage }} — {{ st.name }}</h3>

      <div class="kv">
        {% if st.grit %}
          <div><span>Grit/Polish</span><span>{{ st.grit }} ({{ brand }})</span></div>
        {% elsif st.polish %}
          <div><span>Polish</span><span>{{ st.polish }} ({{ brand }})</span></div>
        {% endif %}

        <div><span>Start</span><span>{{ st.start | default: "—" }}</span></div>
        <div><span>End</span><span>{{ st.end   | default: "—" }}</span></div>
        <div><span>Barrel fill</span><span>{{ st.barrel_fill_pct | default: "—" }}</span></div>
        <div><span>Water level</span><span>{{ st.water_level | default: "—" }}</span></div>
        <div><span>Media used</span><span>{{ st.media_used | default: "—" }}</span></div>
        <div><span>Amount (Tbsp)</span><span>{{ st.amount_tbsp | default: "—" }}</span></div>

        {% if st.maintenance %}
          <div><span>Maintenance</span><span>{{ st.maintenance }}</span></div>
        {% endif %}
      </div>

      {% if st.observations %}
        <p class="obs"><strong>Observations:</strong> {{ st.observations }}</p>
      {% endif %}

      {% assign dec = st.decision %}
      {% if dec %}
        {% if dec.repeat %}
          <p class="decision"><strong>Decision:</strong> Repeat{% if dec.why %} — {{ dec.why }}{% endif %}</p>
        {% elsif dec.why %}
          <p class="decision"><strong>Decision:</strong> {{ dec.why }}</p>
        {% endif %}
      {% endif %}

      {% if imgs and imgs.size > 1 %}
        <div class="stage-gallery">
          {% for extra in imgs offset:1 %}
            {% if extra.alt != nil %}
              {% assign ex = extra.src | default: extra | image_exists %}
              {% if ex %}<img src="{{ ex | relative_url }}" alt="{{ extra.alt }}">{% endif %}
            {% else %}
              {% assign ex = extra | image_exists %}
              {% if ex %}<img src="{{ ex | relative_url }}" alt="Stage {{ st.stage }} extra image {{ forloop.index }}">{% endif %}
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </section>
{% endfor %}

{% if page.images.gallery and page.images.gallery.size > 0 %}
  <h2>Gallery</h2>
  <div class="grid gallery">
    {% for g in page.images.gallery %}
      {% if g.src %}
        {% assign gs = g.src | image_exists %}
        {% if gs %}
          <figure>
            <img src="{{ gs | relative_url }}" alt="{{ g.alt | default: "" }}">
            {% if g.caption %}<figcaption>{{ g.caption }}</figcaption>{% endif %}
          </figure>
        {% endif %}
      {% else %}
        {% assign g1 = g | image_exists %}
        {% if g1 %}
          <figure>
            <img src="{{ g1 | relative_url }}" alt="">
          </figure>
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>
{% endif %}

<style>
/* Minimal page-local styles; your main stylesheet can refine these */
.tumble-meta{display:grid;gap:1rem;grid-template-columns:1fr}
.tumble-cover img{width:100%;max-height:280px;object-fit:cover;border-radius:8px}
.tumble-details{list-style:none;padding:0;margin:0}
.tumble-details li{margin:.25rem 0}
/* When no cover image, keep spacing tidy */
.tumble-meta.no-cover{grid-template-columns:1fr; gap: .75rem}
/* Vertically center cover against details */
.tumble-cover{align-self:center}

.chips{display:inline-flex;gap:.35rem;flex-wrap:wrap}
.chip{display:inline-block;padding:.15rem .5rem;border-radius:999px;font-size:.85em;border:1px solid rgba(0,0,0,.1)}

/* Rock colour chips (extend as needed) */
.chip--agate{background:#f6efe9}
.chip--jasper{background:#f2e6e1}
.chip--sodalite{background:#e8eef9}
.chip--quartz{background:#f4f4f4}
.chip--dalmatian-jasper{background:repeating-linear-gradient(45deg,#f2e6e1,#f2e6e1 6px,#e8d9d2 6px,#e8d9d2 12px)}
/* generic fallback */
[class^="chip--"]:not(.chip--agate):not(.chip--jasper):not(.chip--sodalite):not(.chip--quartz):not(.chip--dalmatian-jasper){background:#eef3ff}

.stage-card{display:grid;gap:1rem;grid-template-columns:1fr;align-items:start;margin:1.5rem 0;padding:1rem;border:1px solid rgba(0,0,0,.06);border-radius:8px;background:#fafafa}
/* If a stage has no media, collapse to single column at all sizes */
.stage-card.no-media{grid-template-columns:1fr}
/* Vertically center stage image column relative to content */
.stage-media{align-self:center}
.stage-media img{width:100%;border-radius:6px}
.kv{display:grid;grid-template-columns:1fr 1fr;gap:.35rem .75rem;margin:.5rem 0}
.kv > div{display:contents}
.kv > div > span:first-child{color:#555}
.kv > div > span:last-child{text-align:right}
.obs{margin:.5rem 0}
.stage-gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:.5rem;margin-top:.5rem}
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:.75rem}
.gallery figure{margin:0}
.gallery img{width:100%;border-radius:6px}
@media (min-width: 820px){
  .tumble-meta{grid-template-columns: 320px 1fr}
  .tumble-meta.no-cover{grid-template-columns: 1fr}
  .stage-card{grid-template-columns: 260px 1fr}
  .stage-card.no-media{grid-template-columns: 1fr}
}
</style>
