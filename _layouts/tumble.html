---
layout: default
---

<article class="tumble-entry">

  {%- comment -%} ---------- Constants / helpers ---------- {%- endcomment -%}
  {%- assign placeholder = '/assets/tumbling/coming-soon.jpg' -%}
  {%- assign status = page.status | default: 'Pending' -%}

  {%- comment -%} ---------- Title & meta ---------- {%- endcomment -%}
  <header class="tumble-header">
    <h1 class="tumble-title">{{ page.title | default: page.batch }}</h1>

    <div class="tumble-meta">
      <span class="chip chip-status chip-status--{{ status | downcase | replace: ' ', '-' }}">{{ status }}</span>

      {%- if page.rocks and page.rocks.size > 0 -%}
        <span class="meta-sep">•</span>
        <span class="chip-row">
          {%- for rock in page.rocks -%}
            {%- assign rock_cls = rock | downcase | replace: ' ', '-' -%}
            <span class="chip chip-rock rock-{{ rock_cls }}">{{ rock }}</span>
          {%- endfor -%}
        </span>
      {%- endif -%}

      <div class="tumble-dates">
        {%- if page.date_started -%}<span><strong>Start:</strong> {{ page.date_started }}</span>{%- endif -%}
        {%- if page.date_finished -%}<span><strong>Finish:</strong> {{ page.date_finished }}</span>{%- endif -%}
      </div>

      <div class="tumble-gear">
        {%- if page.tumbler -%}<span><strong>Tumbler:</strong> {{ page.tumbler }}</span>{%- endif -%}
        {%- if page.origin -%}<span><strong>Origin:</strong> {{ page.origin }}</span>{%- endif -%}
      </div>
    </div>
  </header>

  {%- comment -%} ---------- Overall progress (auto) ---------- {%- endcomment -%}
  {%- assign pct = 0 -%}
  {%- assign total = 4 -%}
  {%- if page.stages and page.stages.size > 0 -%}
    {%- assign total = page.stages.size -%}
    {%- assign done = 0 -%}
    {%- for st in page.stages -%}
      {%- if st.end -%}{%- assign done = done | plus: 1 -%}{%- endif -%}
    {%- endfor -%}
    {%- assign pct = done | times: 100 | divided_by: total -%}
  {%- endif -%}
  {%- if page.status == 'Completed' or page.date_finished -%}{%- assign pct = 100 -%}{%- endif -%}

  <div class="tumble-progress">
    <div class="tumble-progress__bar">
      <span class="tumble-progress__fill" style="width: {{ pct }}%"></span>
    </div>
    <div class="tumble-progress__label">{{ pct }}%</div>
  </div>

  {%- comment -%} ---------- Photos: rough + optional cover + gallery ---------- {%- endcomment -%}
  {%- assign rough_url = page.images.rough | default: page.images.cover | default: placeholder -%}
  <figure class="tumble-rough{%- if rough_url == placeholder -%} is-placeholder{%- endif -%}">
    <img src="{{ rough_url | relative_url }}" alt="{{ page.title }} – rough load" loading="lazy" decoding="async">
    <figcaption>Rough load{%- if rough_url == placeholder -%} (placeholder){%- endif -%}</figcaption>
  </figure>

  {%- assign cover_url = nil -%}
  {%- if page.images and page.images.cover -%}
    {%- assign cover_url = page.images.cover -%}
  {%- elsif page.images and page.images.gallery and page.images.gallery.size > 0 -%}
    {%- assign first = page.images.gallery[0] -%}
    {%- assign cover_url = first.src | default: first -%}
  {%- endif -%}

  {%- if cover_url and cover_url != rough_url -%}
    <figure class="tumble-cover">
      <img src="{{ cover_url | relative_url }}" alt="{{ page.title }} – cover" loading="lazy" decoding="async">
    </figure>
  {%- endif -%}

  {%- if page.images and page.images.gallery and page.images.gallery.size > 0 -%}
    <div class="tumble-gallery">
      {%- for shot in page.images.gallery -%}
        {%- assign url = shot.src | default: shot -%}
        {%- assign alt = shot.alt | default: page.title -%}
        <a class="t-shot" href="{{ url | relative_url }}" target="_blank" rel="noopener">
          <img src="{{ url | relative_url }}" alt="{{ alt }}" loading="lazy" decoding="async">
        </a>
      {%- endfor -%}
    </div>
  {%- endif -%}

  {%- comment -%} ---------- Notes (optional) ---------- {%- endcomment -%}
  {%- if page.notes -%}
    <div class="tumble-notes">
      <h2>Notes</h2>
      <p>{{ page.notes }}</p>
    </div>
  {%- endif -%}

  {%- comment -%} ---------- Stages ---------- {%- endcomment -%}
  {%- if page.stages and page.stages.size > 0 -%}
    {%- for st in page.stages -%}
      {%- assign s = st.stage | default: forloop.index -%}
      <section class="tumble-stage-block" id="stage-{{ s }}">
        <h3>Stage {{ s }} — {{ st.name | default: 'Stage' }}</h3>

        {%- comment -%} Stage “after” image (1–4) with placeholder {%- endcomment -%}
        {%- assign after_url = nil -%}
        {%- if s == 1 -%}
          {%- assign after_url = page.images.after_stage_1 -%}
        {%- elsif s == 2 -%}
          {%- assign after_url = page.images.after_stage_2 -%}
        {%- elsif s == 3 -%}
          {%- assign after_url = page.images.after_stage_3 -%}
        {%- elsif s == 4 -%}
          {%- assign after_url = page.images.after_stage_4 -%}
        {%- endif -%}
        {%- assign after_url = after_url | default: placeholder -%}

        <figure class="stage-after{%- if after_url == placeholder -%} is-placeholder{%- endif -%}">
          <img src="{{ after_url | relative_url }}" alt="After Stage {{ s }}" loading="lazy" decoding="async">
          <figcaption>After Stage {{ s }}{%- if after_url == placeholder -%} (placeholder){%- endif -%}</figcaption>
        </figure>

        {%- if s == 4 -%}
          {%- assign burnish_url = page.images.after_burnish | default: placeholder -%}
          <figure class="stage-after{%- if burnish_url == placeholder -%} is-placeholder{%- endif -%}">
            <img src="{{ burnish_url | relative_url }}" alt="After Burnish" loading="lazy" decoding="async">
            <figcaption>After Burnish{%- if burnish_url == placeholder -%} (placeholder){%- endif -%}</figcaption>
          </figure>
        {%- endif -%}

        {%- comment -%} Stage table (compact two-col) {%- endcomment -%}
        <table class="tumble-stage">
          <tbody>
            <tr>
              <th>{% if s == 4 %}Polish{% else %}Grit{% endif %}</th>
              <td>
                {%- if s == 4 -%}
                  {{ st.polish | default: '—' }}
                {%- else -%}
                  {{ st.grit | default: '—' }}
                {%- endif -%}
                {%- if page.consumables_brand -%}
                  <span class="subtext">({{ page.consumables_brand }})</span>
                {%- endif -%}
              </td>
            </tr>
            <tr><th>Start</th><td>{{ st.start | default: '—' }}</td></tr>
            <tr><th>End</th><td>{{ st.end | default: '—' }}</td></tr>
            {%- assign sd = st.start | date: "%s" -%}
            {%- assign ed = st.end | date: "%s" -%}
            {%- if st.start and st.end and sd and ed -%}
              {%- assign ssec = ed | minus: sd -%}
              {%- assign sdays = ssec | divided_by: 86400 -%}
              <tr><th>Duration (days)</th><td>{{ sdays }}</td></tr>
            {%- else -%}
              <tr><th>Duration (days)</th><td>—</td></tr>
            {%- endif -%}
            <tr><th>Barrel fill %</th><td>{{ st.barrel_fill_pct | default: '—' }}</td></tr>
            <tr><th>Water level</th><td>{{ st.water_level | default: '—' }}</td></tr>
            <tr><th>Media used</th><td>{{ st.media_used | default: '—' }}</td></tr>
            <tr><th>Amount (Tbsp)</th><td>{{ st.amount_tbsp | default: '—' }}</td></tr>
            {%- if st.maintenance -%}<tr><th>Maintenance</th><td>{{ st.maintenance }}</td></tr>{%- endif -%}
            <tr><th>Observations</th><td>{{ st.observations | default: '—' }}</td></tr>
            {%- if st.decision and (st.decision.repeat or st.decision.why) -%}
              <tr>
                <th>Decision</th>
                <td>
                  {%- if st.decision.repeat == true -%}Repeat (why: {{ st.decision.why | default: '—' }})
                  {%- elsif st.decision.repeat == false -%}Don’t repeat
                  {%- else -%}—{%- endif -%}
                </td>
              </tr>
            {%- endif -%}
          </tbody>
        </table>
      </section>
    {%- endfor -%}
  {%- endif -%}

  {%- comment -%} ---------- Lightbox (minimal) ---------- {%- endcomment -%}
  <div id="lb" class="lightbox" hidden>
    <button class="lb-close" aria-label="Close">×</button>
    <img class="lb-img" alt="">
    <div class="lb-cap"></div>
  </div>

  <script>
  (function () {
    const lb = document.getElementById('lb');
    if (!lb) return;
    const imgEl = lb.querySelector('.lb-img');
    const capEl = lb.querySelector('.lb-cap');
    const closeBtn = lb.querySelector('.lb-close');

    function openLB(url, alt, caption) {
      imgEl.src = url;
      imgEl.alt = alt || '';
      capEl.textContent = caption || '';
      lb.hidden = false;
      document.documentElement.style.overflow = 'hidden';
    }
    function closeLB() {
      lb.hidden = true;
      imgEl.src = '';
      capEl.textContent = '';
      document.documentElement.style.overflow = '';
    }

    closeBtn.addEventListener('click', closeLB);
    lb.addEventListener('click', (e) => { if (e.target === lb) closeLB(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeLB(); });

    document.querySelector('.tumble-entry')?.addEventListener('click', (e) => {
      const link = e.target.closest('a.t-shot');
      const img  = e.target.closest('.tumble-cover img, .tumble-rough img, .stage-after img');
      if (link) {
        e.preventDefault();
        const url = link.getAttribute('href');
        const alt = link.querySelector('img')?.getAttribute('alt') || '';
        openLB(url, alt, '');
      } else if (img) {
        e.preventDefault();
        const url = img.getAttribute('src');
        const alt = img.getAttribute('alt') || '';
        let caption = '';
        const fig = img.closest('figure');
        if (fig) {
          const cap = fig.querySelector('figcaption');
          caption = cap ? cap.textContent.trim() : '';
        }
        openLB(url, alt, caption);
      }
    });
  })();
  </script>
</article>