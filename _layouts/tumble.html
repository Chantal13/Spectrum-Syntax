---
layout: default
---

{% comment %}
Helpers
{% endcomment %}
{% assign brand = page.consumables_brand | default: "National Geographic" %}

{% assign cover_candidate =
  page.images.cover
  | default: page.images.after_stage_4
  | default: page.images.after_burnish
  | default: page.images.rough
%}
{% assign cover = cover_candidate | image_exists %}

<h1>{{ page.title }}</h1>

<div class="tumble-meta{% unless cover %} no-cover{% endunless %}">
  {% if cover %}
    <div class="tumble-cover">
      <img src="{{ cover | relative_url }}" alt="{{ page.title }} cover image">
    </div>
  {% endif %}

  <ul class="tumble-details">
    <li><strong>Batch:</strong> {{ page.batch }}</li>
    {% assign raw = page.status | default: "pending" | downcase | strip %}
    {% assign st = raw %}
    {% if raw == "completed" or raw == "finished" or raw == "done" %}
      {% assign st = "tumbled" %}
    {% elsif raw == "in progress" or raw == "in-progress" or raw == "progress" or raw == "running" or raw == "active" %}
      {% assign st = "tumbling" %}
    {% elsif raw == "pending" or raw == "planned" or raw == "queued" %}
      {% assign st = "pending" %}
    {% endif %}
    <li><strong>Status:</strong> <span class="status status--{{ st }}">{{ st }}</span></li>
    <li><strong>Started:</strong> {{ page.date_started | default: "—" }}</li>
    <li><strong>Finished:</strong> {{ page.date_finished | default: "—" }}</li>
    <li><strong>Tumbler:</strong> {{ page.tumbler | default: "—" }}</li>
    <li><strong>Origin:</strong> {{ page.origin | default: "—" }}</li>
    {% if page.rocks and page.rocks.size > 0 %}
    <li>
      <strong>Rocks:</strong>
      <span class="chips">
        {% for rock in page.rocks %}
          {% assign rk = rock | downcase | strip | replace: " ", "-" | replace: "_", "-" | replace: "/", "-" %}
          <span class="chip chip--{{ rk }}">{{ rock }}</span>
        {% endfor %}
      </span>
    </li>
    {% endif %}
  </ul>
</div>

{%- assign before = page.images.rough | image_exists -%}
{%- if before -%}
<h2>Before Tumbling</h2>
<div class="pre-tumble">
  <img src="{{ before | relative_url }}" alt="Before tumbling (rough)">
</div>
{%- endif -%}

{% if page.notes %}
<div class="tumble-notes">
  <h2>Notes</h2>
  <p>{{ page.notes }}</p>
</div>
{% endif %}

<hr>

<h2>Stages</h2>

{% assign empty_array = "" | split: "," %}
{% for st in page.stages %}
  {% assign imgs = st.images | default: empty_array %}
  {% assign primary = nil %}

  {% if imgs and imgs.size > 0 %}
    {% assign primary = imgs[0] %}
  {% endif %}

  {% if primary == nil %}
    {% assign k = "after_stage_" | append: st.stage %}
    {% assign primary = page.images[k] %}
  {% endif %}

  {%- comment -%} Fallbacks: prefer nearest previous stage image before using rough {%- endcomment -%}
  {% if primary == nil %}
    {% assign s = st.stage | plus: 0 %}
    {% if s == 5 %}
      {% assign primary = page.images.after_burnish %}
      {% if primary == nil %}
        {% assign primary = page.images.after_stage_4 %}
      {% endif %}
      {% if primary == nil %}
        {% assign primary = page.images.after_stage_3 %}
      {% endif %}
      {% if primary == nil %}
        {% assign primary = page.images.after_stage_2 %}
      {% endif %}
      {% if primary == nil %}
        {% assign primary = page.images.after_stage_1 %}
      {% endif %}
    {% elsif s == 4 %}
      {% assign primary = page.images.after_stage_3 %}
      {% if primary == nil %}
        {% assign primary = page.images.after_stage_2 %}
      {% endif %}
      {% if primary == nil %}
        {% assign primary = page.images.after_stage_1 %}
      {% endif %}
    {% elsif s == 3 %}
      {% assign primary = page.images.after_stage_2 %}
      {% if primary == nil %}
        {% assign primary = page.images.after_stage_1 %}
      {% endif %}
    {% elsif s == 2 %}
      {% assign primary = page.images.after_stage_1 %}
    {% endif %}
  {% endif %}

  {% if primary == nil %}
    {% assign primary = page.images.rough %}
  {% endif %}

  {% assign primary = primary | image_exists %}

  <h3 id="stage-{{ st.stage }}-title">Stage {{ st.stage }} — {{ st.name }}</h3>
  <section class="stage-card{% unless primary %} no-media{% endunless %}" id="stage-{{ st.stage }}">
    {% if primary %}
      <div class="stage-media">
        <img src="{{ primary | relative_url }}" alt="Stage {{ st.stage }} image">
      </div>
    {% endif %}
    <div class="stage-body">
      <div class="kv">
        {% if st.grit %}
          <div><span>Grit/Polish</span><span>{{ st.grit }} ({{ brand }})</span></div>
        {% elsif st.polish %}
          <div><span>Polish</span><span>{{ st.polish }} ({{ brand }})</span></div>
        {% endif %}

        <div><span>Start</span><span>{{ st.start | default: "—" }}</span></div>
        <div><span>End</span><span>{{ st.end   | default: "—" }}</span></div>
        <div><span>Barrel fill</span><span>{{ st.barrel_fill_pct | default: "—" }}</span></div>
        <div><span>Water level</span><span>{{ st.water_level | default: "—" }}</span></div>
        <div><span>Media used</span><span>{{ st.media_used | default: "—" }}</span></div>
        <div><span>Amount (Tbsp)</span><span>{{ st.amount_tbsp | default: "—" }}</span></div>

        {% if st.maintenance %}
          <div><span>Maintenance</span><span>{{ st.maintenance }}</span></div>
        {% endif %}
      </div>

      {% if st.observations %}
        <p class="obs"><strong>Observations:</strong> {{ st.observations }}</p>
      {% endif %}

      {% assign dec = st.decision %}
      {% if dec %}
        {% if dec.repeat %}
          <p class="decision"><strong>Decision:</strong> Repeat{% if dec.why %} — {{ dec.why }}{% endif %}</p>
        {% elsif dec.why %}
          <p class="decision"><strong>Decision:</strong> {{ dec.why }}</p>
        {% endif %}
      {% endif %}

      {% if imgs and imgs.size > 1 %}
        <div class="stage-gallery">
          {% for extra in imgs offset:1 %}
            {% if extra.alt != nil %}
              {% assign ex = extra.src | default: extra | image_exists %}
              {% if ex %}<img src="{{ ex | relative_url }}" alt="{{ extra.alt }}">{% endif %}
            {% else %}
              {% assign ex = extra | image_exists %}
              {% if ex %}<img src="{{ ex | relative_url }}" alt="Stage {{ st.stage }} extra image {{ forloop.index }}">{% endif %}
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </section>
{% endfor %}

{%- assign after_candidate =
  page.images.after_burnish
  | default: page.images.after_stage_4
  | default: page.images.after_stage_3
  | default: page.images.after_stage_2
  | default: page.images.after_stage_1
-%}
{%- assign after_img = after_candidate | image_exists -%}
{%- if after_img -%}
  <h2>After Tumbling</h2>
  <div class="post-tumble">
    <img src="{{ after_img | relative_url }}" alt="After tumbling">
  </div>
{%- endif -%}

{% if page.images.gallery and page.images.gallery.size > 0 %}
  <h2>Gallery</h2>
  <div class="grid gallery">
    {% for g in page.images.gallery %}
      {% if g.src %}
        {% assign gs = g.src | image_exists %}
        {% if gs %}
          <figure>
            <img src="{{ gs | relative_url }}" alt="{{ g.alt | default: "" }}">
            {% if g.caption %}<figcaption>{{ g.caption }}</figcaption>{% endif %}
          </figure>
        {% endif %}
      {% else %}
        {% assign g1 = g | image_exists %}
        {% if g1 %}
          <figure>
            <img src="{{ g1 | relative_url }}" alt="">
          </figure>
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>
{% endif %}

<!-- Page-local styles moved to SCSS -->
