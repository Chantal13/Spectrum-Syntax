---
layout: default
---

<article class="tumble-entry">
  <h1>{{ page.title }}</h1>

  {%- assign badge_class = page.status_class | default: page.status | downcase | replace: ' ', '-' -%}
  {%- if page.status or (page.rocks and page.rocks.size > 0) -%}
    <div class="tumble-meta">
      {%- if page.status -%}
        <span class="badge {{ badge_class }}">{{ page.status }}</span>
      {%- endif -%}
      {%- if page.rocks and page.rocks.size > 0 -%}
        {%- for r in page.rocks -%}
          <span class="badge rock r-{{ r | slugify }}">{{ r }}</span>
        {%- endfor -%}
      {%- endif -%}
    </div>
  {%- comment -%} Batch photos (cover + gallery) {%- endcomment -%}
  {%- assign cover = nil -%}
  {%- if page.images and page.images.cover -%}
  {%- assign cover = page.images.cover -%}
  {%- elsif page.images and page.images.gallery and page.images.gallery.size > 0 -%}
  {%- assign first = page.images.gallery[0] -%}
  {%- assign cover = first.src | default: first -%}
  {%- endif -%}
  
  {%- if cover -%}
  <figure class="tumble-cover">
    <img src="{{ cover | relative_url }}" alt="{{ page.title }} – cover" loading="lazy" decoding="async">
  </figure>
  {%- endif -%}
  
  {%- if page.images and page.images.gallery and page.images.gallery.size > 0 -%}
  <div class="tumble-gallery">
    {%- for shot in page.images.gallery -%}
    {%- assign url = shot.src | default: shot -%}
    {%- assign alt = shot.alt | default: page.title -%}
    <a class="t-shot" href="{{ url | relative_url }}" target="_blank" rel="noopener">
      <img src="{{ url | relative_url }}" alt="{{ alt }}" loading="lazy" decoding="async">
    </a>
    {%- endfor -%}
  </div>
  {%- endif -%}

  {%- endif -%}

  <p class="mono">
    {%- if page.date_started -%}<strong>Started:</strong> {{ page.date_started }}{%- endif -%}
    {%- if page.date_finished -%} &nbsp; <strong>Finished:</strong> {{ page.date_finished }}{%- endif -%}
    {%- if page.date_started and page.date_finished -%}
      {%- assign s = page.date_started | date: "%s" -%}
      {%- assign e = page.date_finished | date: "%s" -%}
      {%- assign sec = e | minus: s -%}
      {%- assign days = sec | divided_by: 86400 -%}
      &nbsp; <strong>Duration:</strong> {{ days }} days
    {%- endif -%}
  </p>

  {%- if page.tumbler or page.origin -%}
  <ul>
    {%- if page.tumbler -%}<li><strong>Tumbler:</strong> {{ page.tumbler }}</li>{%- endif -%}
    {%- if page.origin -%}<li><strong>Origin:</strong> {{ page.origin }}</li>{%- endif -%}
  </ul>
  {%- endif -%}

  {%- if page.notes and page.notes != "" -%}
    <p>{{ page.notes }}</p>
  {%- endif -%}

  {%- comment -%} Auto stage progress (stage-based preferred, batch dates fallback) {%- endcomment -%}
  {%- assign total = 0 -%}
  {%- assign completed = 0 -%}
  {%- assign active_index = nil -%}

  {%- if page.stages -%}
    {%- for st in page.stages -%}
      {%- if st.name -%}{%- assign total = total | plus: 1 -%}{%- endif -%}
      {%- if st.end -%}{%- assign completed = completed | plus: 1 -%}{%- endif -%}
      {%- if active_index == nil and st.start and st.end == nil -%}
        {%- assign active_index = forloop.index -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}

  {%- assign percent = nil -%}
  {%- if total > 0 -%}
    {%- assign percent = completed | times: 100 | divided_by: total -%}
  {%- else -%}
    {%- if page.date_started and page.date_finished -%}
      {%- assign s = page.date_started | date: "%s" -%}
      {%- assign e = page.date_finished | date: "%s" -%}
      {%- assign now = site.time | date: "%s" -%}
      {%- assign dur = e | minus: s -%}
      {%- assign elapsed = now | minus: s -%}
      {%- if elapsed < 0 -%}{%- assign elapsed = 0 -%}{%- endif -%}
      {%- if elapsed > dur -%}{%- assign elapsed = dur -%}{%- endif -%}
      {%- if dur > 0 -%}
        {%- assign percent = elapsed | times: 100 | divided_by: dur -%}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}

  {%- if total > 0 -%}
    <p class="progressline">
      {%- if completed == total -%}
        <strong>Progress:</strong> Completed ({{ total }} stages) — 100%
      {%- elsif active_index -%}
        <strong>Progress:</strong> Stage {{ active_index }} of {{ total }} — {{ percent | default: 0 }}%
      {%- else -%}
        <strong>Progress:</strong> Stage {{ completed | plus: 1 }} of {{ total }} — {{ percent | default: 0 }}%
      {%- endif -%}
    </p>
  {%- elsif percent -%}
    <p class="progressline"><strong>Progress:</strong> {{ percent }}%</p>
  {%- endif -%}

  {%- if percent -%}
    <div class="progress {{ badge_class }}" role="progressbar"
         aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ percent }}">
      <div class="bar" style="width: {{ percent }}%"></div>
    </div>
  {%- endif -%}

  {%- if page.stages and page.stages.size > 0 -%}
    {%- for st in page.stages -%}
      <hr>
      <h3>Stage {{ st.stage }} — {{ st.name }}</h3>
      <div class="tumble">
        <table class="tumble-table">
          <thead>
            <tr><th>Field</th><th>Notes</th></tr>
          </thead>
          <tbody>
            {%- if st.grit -%}
              <tr>
                <td>Grit</td>
                <td data-label="Grit">
                  {{ st.grit }}{%- if page.consumables_brand -%} ({{ page.consumables_brand }}){%- endif -%}
                </td>
              </tr>
            {%- endif -%}
            {%- if st.polish -%}
              <tr>
                <td>Polish</td>
                <td data-label="Polish">
                  {{ st.polish }}{%- if page.consumables_brand -%} ({{ page.consumables_brand }}){%- endif -%}
                </td>
              </tr>
            {%- endif -%}

            <tr><td>Start Date</td><td data-label="Start Date">{{ st.start | default: "—" }}</td></tr>
            <tr><td>End Date</td><td data-label="End Date">{{ st.end | default: "—" }}</td></tr>

            {%- if st.start and st.end -%}
              {%- assign st_s = st.start | date: "%s" -%}
              {%- assign st_e = st.end   | date: "%s" -%}
              {%- assign st_sec = st_e | minus: st_s -%}
              {%- assign st_days = st_sec | divided_by: 86400 -%}
              <tr><td>Duration (days)</td><td class="mono" data-label="Duration (days)">{{ st_days }}</td></tr>
            {%- else -%}
              <tr><td>Duration (days)</td><td data-label="Duration (days)">—</td></tr>
            {%- endif -%}

            {%- if st.barrel_fill_pct -%}<tr><td>Barrel Fill %</td><td class="mono" data-label="Barrel Fill %">{{ st.barrel_fill_pct }}</td></tr>{%- endif -%}
            {%- if st.water_level -%}<tr><td>Water Level</td><td data-label="Water Level">{{ st.water_level }}</td></tr>{%- endif -%}
            {%- if st.media_used -%}<tr><td>Media Used</td><td data-label="Media Used">{{ st.media_used }}</td></tr>{%- endif -%}
            {%- if st.amount_tbsp -%}<tr><td>Amount (Tbsp)</td><td class="mono" data-label="Amount (Tbsp)">{{ st.amount_tbsp }}</td></tr>{%- endif -%}
            {%- if st.maintenance -%}<tr><td>Maintenance</td><td data-label="Maintenance">{{ st.maintenance }}</td></tr>{%- endif -%}
            {%- if st.observations -%}<tr><td>Observations</td><td data-label="Observations">{{ st.observations }}</td></tr>{%- endif -%}

            {%- assign has_decision = st.decision and (st.decision.repeat != nil or st.decision.why) -%}
            {%- if has_decision -%}
              <tr>
                <td>Decision</td>
                <td data-label="Decision">
                  {%- if st.decision.repeat == true -%}Repeat
                  {%- elsif st.decision.repeat == false -%}Do not repeat
                  {%- else -%}—{%- endif -%}
                  {%- if st.decision.why -%} — {{ st.decision.why }}{%- endif -%}
                </td>
              </tr>
            {%- endif -%}
          </tbody>
        </table>
      </div>
    {%- endfor -%}
  {%- else -%}
    <p><em>No stages defined.</em></p>
  {%- endif -%}
</article>
